From 494cba05c4cb09d16588ac1112a51d8a6cbec206 Mon Sep 17 00:00:00 2001
From: halfmaster1 <ohpointfive@gmail.com>
Date: Fri, 21 May 2021 23:10:44 -0400
Subject: [PATCH] Add random enchantment protection option


diff --git a/src/main/java/net/minecraft/server/EnchantmentManager.java b/src/main/java/net/minecraft/server/EnchantmentManager.java
index 98656815..2034493d 100644
--- a/src/main/java/net/minecraft/server/EnchantmentManager.java
+++ b/src/main/java/net/minecraft/server/EnchantmentManager.java
@@ -2,6 +2,7 @@ package net.minecraft.server;
 
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
+import org.github.paperspigot.PaperSpigotConfig;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.Iterator;
@@ -148,7 +149,11 @@ public class EnchantmentManager {
             EnchantmentManager.b.a = 0;
         }
 
-        return (EnchantmentManager.b.a + 1 >> 1) + EnchantmentManager.a.nextInt((EnchantmentManager.b.a >> 1) + 1);
+        if (PaperSpigotConfig.enchantmentRandomProtection) {
+            return (EnchantmentManager.b.a + 1 >> 1) + EnchantmentManager.a.nextInt((EnchantmentManager.b.a >> 1) + 1);
+        } else {
+            return (EnchantmentManager.b.a + 1 >> 1) + (((EnchantmentManager.b.a >> 1) + 1) / 2);
+        }
     }
 
     public static float a(ItemStack itemstack, EnumMonsterType enummonstertype) {
diff --git a/src/main/java/org/github/paperspigot/PaperSpigotConfig.java b/src/main/java/org/github/paperspigot/PaperSpigotConfig.java
index 34217d3c..86e9c442 100644
--- a/src/main/java/org/github/paperspigot/PaperSpigotConfig.java
+++ b/src/main/java/org/github/paperspigot/PaperSpigotConfig.java
@@ -143,6 +143,11 @@ public class PaperSpigotConfig
         criticalHitMultiplier = (float) getDouble("settings.critical-hit-multiplier", (double) criticalHitMultiplier);
     }
 
+    public static boolean enchantmentRandomProtection = true;
+    private static void enchantmentRandomProtection() {
+        enchantmentRandomProtection = getBoolean("settings.enchantment-random-protection", enchantmentRandomProtection);
+    }
+
     public static boolean tickEmptyWorlds = true;
     private static void tickEmptyWorlds() {
         tickEmptyWorlds = getBoolean("settings.tick-empty-worlds", tickEmptyWorlds);
-- 
2.29.2

